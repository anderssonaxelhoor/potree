<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Swescan Pointcloud Viewer</title>

	<link rel="stylesheet" type="text/css" href="../build/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="../libs/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="../libs/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="../libs/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="../libs/jstree/themes/mixed/style.css">
 	<script type="text/javascript">
		
	//Sätt in önskade länkar/text här:
	//PUNKTMOLN. Tänk på att ha allt i samma mapp.
	//"../pointclouds/classtest/pointclouds/letcher/metadata.json"
	punktmoln = "../pointclouds/classtest/pointclouds/letcher/metadata.json"
	projektnamn = "Bohus"
	kordinatsystem = "SWEREF99TM - RH2000" //Vilket kordinatsystem som ska anges på skärmen
	//punktmoln2 =""
	//projektnamn2 = ""
	//Alternativ klassificering. Lämna som "custom = {}" alt kommenteraom du inte vill ha alternativ klassificering, se ClassificationScheme.js för orginalklassificering"
	custom = {
		4:       { visible: true, name: 'medium vegetation' , color: [0.0,  0.8,  0.0,  1.0] },
		DEFAULT: { visible: true, name: 'default'           , color: [0.3,  0.6,  0.6,  0.5] },
		}

	//Oreinted Images. Viktigt att att bilderna är samma mapp som filerna nedan
	oiimageparameters = "../images/inspection_wall/OIimageparams.txt" //koordnater och rotation för bilderna
	oicameraparameters = "../images/inspektionsbilder/many3.xml" //specifikation av bilderna. 
	

	
	// Nedanstående gör så att om custom(alternativa klassificeringslistan som finns ovan) är tom så syns inte knapparna i botten
	window.onload = function(){
			var buttons = document.getElementsByClassName("buttons");
			
			if(Object.keys(custom) == 0){
				
			for(var i = 0; i<buttons.length; i++){
					buttons[i].style.display = "none";
				}
			}
	}
	</script>
	<style>
	
		#potree_toolbar{
			position: absolute; 
			z-index: 10000; 
			right: 3%; 
			max-width: 75%;
			top: 5px;
			background: rgba(0,0, 0, 0.25);
			/*
position: absolute; 
	bottom: 5px; 
	right: 0%; 
	transform: translateX(-50%); 
	text-align: center;
	z-index:	1000;
			*/

			
			color: white;
			padding: 0.3em 0.8em;
			font-family: "system-ui";
			border-radius: 0.3em 0.3em 0.3em 0.3em;
			display: flex;

		}
	
		.potree_toolbar_label{
			text-align: center;
			font-size: smaller;
			opacity: 0.9;
		}
	
		.potree_toolbar_separator{
			background: white;
			padding: 0px;
			margin: 5px 10px;
			width: 1px;
		}
		</style>

</head>

<body>
	<script src="../libs/jquery/jquery-3.1.1.min.js"></script>
	<script src="../libs/spectrum/spectrum.js"></script>
	<script src="../libs/jquery-ui/jquery-ui.min.js"></script>
	<!--perfect-scrollbar?-->
	
	
	<script src="../libs/other/BinaryHeap.js"></script>
	<script src="../libs/tween/tween.min.js"></script>
	<script src="../libs/d3/d3.js"></script>
	<script src="../libs/proj4/proj4.js"></script>
	<script src="../libs/openlayers3/ol.js"></script>
    <script src="../libs/i18next/i18next.js"></script>
    <script src="../libs/jstree/jstree.js"></script>
	<!--<script src="../src/viewer/modal.js"></script>-->
	
	<script src="../build/potree/potree.js"></script>
	<script src="../libs/plasio/js/laslaz.js"></script>
    
	
	<!-- INCLUDE ADDITIONAL DEPENDENCIES HERE 
		document.title = "Swescan new pointcloud viewer";
		viewer.setEDLEnabled(true);
		viewer.setBackground("white");  ["skybox", "gradient", "black", "white"];
		-->
	<!-- INCLUDE SETTINGS HERE -->
	<!--<div class = "topnav">
		<a href=https://sweportal.swescan.se><img src = "../bilder/Logotype_Sweportal_Points_white2.png"></a>
	</div>-->
	<div class="topnav">
		<a href=https://sweportal.swescan.se Style="float: none;"><img src = "../bilder/swepoertal_points_WBG.png" Style="object-fit: contain;"></a>
		<!--<a href=https://sweportal.swescan.se><img src = "../bilder/swepoertal_points_WBG.png" Style=" float: right;"></a>-->
		<a href=https://sweportal.swescan.se/profile target="_blank" style="right: 0;"><img src="../resources/ikoner/user.svg" Style="object-fit: scale down; margin-left: 10px; margin-right: 10px;"></a>
		<!--<a href=https://swescan.se/sweportal-support/ style="float: right;"><img src="../resources/ikoner/wrench.svg" Style="object-fit: scale down; margin-left: 10px; margin-right: 10px;"></a>-->
		
	</div>

	<div class="potree_container" style="position: flex; width: 100%; height: 100%; left: 0px; top: 8%;">
		
		<div id="potree_render_area">
			<div id="potree_toolbar"></div>
			<!-- <div class="modal" id="modal">
				<div class="modal-header">
				<div class="title">Profile Settings</div>
				<button data-close-button class="close-button">&times;</button>
			</div>
			<div class="modal-body">Profil</div>
			
			</div>
			<div id="overlay"></div> -->
			<span style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 10000">
				<input type="button" class="buttons" value="Default Scheme" onclick="setDefaultScheme()"/>
				<input type="button" class="buttons" value="Custom Scheme" onclick="setTreeScheme()"/>
			</span>
		<div id="potree_sidebar_container" style="height: 50%"></div>		
		</div>
		<!--<div id="potree_sidebar_container"></div> Flytta upp i render_area kanske gör så att de överlappar snyggt-->
	</div>
	

	
	<script type="module">

	import * as THREE from "../libs/three.js/build/three.module.js";
	
		window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));
		viewer.loadGUI(() => {
		viewer.setEDLEnabled(true);
		viewer.setFOV(60);
		viewer.setPointBudget(8_000_000);
		viewer.setEDLEnabled(true);
		viewer.setBackground("black")
		viewer.setDescription("../bilder/Powered_by_Swescan_dark_grey.png");
		viewer.setDescription2(kordinatsystem);
		viewer.loadSettingsFromURL();
		
		
			viewer.setLanguage('en');
			//$("#menu_scene").next().show();
			viewer.toggleSidebar();
			viewer.compass.setVisible(true);
		});
		
		// plane
		//Potree.loadPointCloud("../pointclouds/C/dev/epalinges/epalinges/als_converted/cloud.js", "epalinges", e => {
		Potree.loadPointCloud(punktmoln, projektnamn, function(e){
			viewer.scene.addPointCloud(e.pointcloud);
			
			let material = e.pointcloud.material;
			material.size = 1;
			material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
			
			viewer.fitToScreen();
			// run();
		});
		//Ifall man vill ha flera punktmoln
/* 		Potree.loadPointCloud(punktmoln2,Projektnamn2, function(e){
			viewer.scene.addPointCloud(e.pointcloud);
			
			let material = e.pointcloud.material;
			material.size = 1;
			material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
			
			viewer.fitToScreen();
		}); */

		/* async function run(){

				proj4.defs("WGS84", "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs");
				proj4.defs("pointcloud", viewer.getProjection());
				let transform = proj4("WGS84", "pointcloud");

				let params = {
				transform: transform
				};

			// this file contains coordinates, orientation and filenames of the images:
			// http://5.9.65.151/mschuetz/potree/resources/pointclouds/helimap/360/Drive2_selection/coordinates.txt
			Potree.Images360Loader.load("http://5.9.65.151/mschuetz/potree/resources/pointclouds/helimap/360/Drive2_selection", viewer, params).then( images => {
				viewer.scene.add360Images(images);
			});

			viewer.mapView.showSources(false);
		} */
	</script>
	<!--Om man vill lägga till bildfunktionen-->
	<script type="module">

		import * as THREE from "../libs/three.js/build/three.module.js";
		
			const cameraParamsPath = oicameraparameters;
			const imageParamsPath = oiimageparameters;
			
				 Potree.OrientedImageLoader.load(cameraParamsPath, imageParamsPath, viewer).then( images => {
					viewer.scene.addOrientedImages(images);
					
				});
					//
					 const cameraParamsPath1 = "../images/Inspektionsbilder/many3.xml";
			const imageParamsPath1 = "../images/Inspektionsbilder/many5.txt";
			
				 Potree.OrientedImageLoader.load(cameraParamsPath1, imageParamsPath1, viewer).then( images => {
					viewer.scene.addOrientedImages(images);
					
					
				}); 
		</script>

<script type="module">

	import * as THREE from "../libs/three.js/build/three.module.js";

	window.setDefaultScheme = function(){
		viewer.setClassifications(Potree.ClassificationScheme.DEFAULT);
	}

	// Set classification
	window.setTreeScheme = function(){
		viewer.setClassifications(custom);
	}



</script>

<script type="module">

	import * as THREE from "../libs/three.js/build/three.module.js";
	
	// 1: define html of toolbar first 
	// 2: then populate with content and actions 
	//
	// Following files can be used as references on how to add certain functionality to the toolbar:
	// - sidebar.html
	// - sidebar.js
	// - PropertiesPanel.html and its dependencies (DistancePanel, ProfilePanel, ...)
	// 
	

	// HTML
	const elToolbar = $("#potree_toolbar");
	elToolbar.html(`
		<!--<span>
			<div class="potree_toolbar_label">
				Coordinate System
			</div>
			<div>
			${parent.kordinatsystem}
			</div>
		</span>
		<span class="potree_toolbar_separator" />-->
		<span>
			<div class="potree_toolbar_label">
				View
			</div>
			<div>
				<img name="action_elevation" src="${Potree.resourcePath}/ikoner/2.ico" class="annotation-action-icon" style="width: 2em; height: auto;"/>
				<img name="action_rgb" src="${Potree.resourcePath}/icons/rgb.svg" class="annotation-action-icon" style="width: 2em; height: auto;"/>
			</div>
		</span>

		

		<span class="potree_toolbar_separator" />

		<span>
			<div class="potree_toolbar_label">
				Tools
			</div>
			<div>
				<!--<li id="toolbar_tools"></li>-->
				<img name="action_measure_point" src="${Potree.resourcePath}/ikoner/sw_point.svg" class="annotation-action-icon" style="width: 2em; height: auto;"/>
				<img name="action_measure_distance" src="${Potree.resourcePath}/ikoner/sw_distance2.png" class="annotation-action-icon" style="width: 2em; height: auto;"/>
				<img name="action_measure_height" src="${Potree.resourcePath}/ikoner/sw_height.svg" class="annotation-action-icon" style="width: 2em; height: auto;"/>
				<img name="action_measure_profile" src="${Potree.resourcePath}/ikoner/sw_profile2.png" class="annotation-action-icon" style="width: 2em; height: auto;"/>
				<img name="action_measure_reset" src="${Potree.resourcePath}/ikoner/sw_reset_tools2.png" class="annotation-action-icon" style="width: 2em; height: auto;"/>
			</div>
		<!--<button data-model-target="#modal">Elevation</button>-->
		</span>

		<span class="potree_toolbar_separator" />

		<span>
			<div class="potree_toolbar_label">
				Clipping
			</div>
			<div id="clipping_tools"></ul>
				
			</div>
		</span>

		<span class="potree_toolbar_separator" />

		<!--<span>
			<div class="potree_toolbar_label" style="width: 12em">
				Material
			</div>
			<div>
				<select id="optMaterial" name="optMaterial"></select>
			</div>
		</span>

		<span class="potree_toolbar_separator" />-->
		
		<span>
			<div class="potree_toolbar_label">
				Navigation
			</div>
			<div id="navigation">
				 
			</div>
		</span>
		<!--
		<span class= "potree_toolbar_separator" />
		
		<span>
			<div class="potree_toolbar_label" style="width: 12em">
				Oriented Images
			</div>
			<div>
				<label><input type="checkbox" id="chckOI"/>toggle OI</span></label
			</div>
		</span>-->
	`);

	// CONTENT & ACTIONS

	{ // ATTRIBUTE
		elToolbar.find("img[name=action_elevation]").click( () => {
			viewer.scene.pointclouds.forEach( pc => pc.material.activeAttributeName = "elevation" );
		});

		elToolbar.find("img[name=action_rgb]").click( () => {
			viewer.scene.pointclouds.forEach( pc => pc.material.activeAttributeName = "rgba" );
		});
	}

	{ // GRADIENT
		const schemes = Object.keys(Potree.Gradients).map(name => ({name: name, values: Potree.Gradients[name]}));
		const elGradientSchemes = elToolbar.find("span[name=gradient_schemes]");

		for(const scheme of schemes){
			const elButton = $(`
				<span style=""></span>
			`);

			const svg = Potree.Utils.createSvgGradient(scheme.values);
			svg.setAttributeNS(null, "class", `button-icon`);
			svg.style.height = "2em";
			svg.style.width = "1.3em";

			elButton.append($(svg));

			elButton.click( () => {
				for(const pointcloud of viewer.scene.pointclouds){
					pointcloud.material.activeAttributeName = "elevation";
					pointcloud.material.gradient = Potree.Gradients[scheme.name];
				}
			});

			elGradientSchemes.append(elButton);
		}
	}


	{ // MEASURE
		
		//Koordinater
		elToolbar.find("img[name=action_measure_point]").click( () => {
			const measurement = viewer.measuringTool.startInsertion({
				showDistances: false,
				showAngles: false,
				showCoordinates: true,
				showArea: false,
				closed: true,
				maxMarkers: 1,
				name: 'Point'
			});
			let measurementsRoot = $("#jstree_scene").jstree().get_json("measurements");
				let jsonNode = measurementsRoot.children.find(child => child.data.uuid === measurement.uuid);
				$.jstree.reference(jsonNode.id).deselect_all();
				$.jstree.reference(jsonNode.id).select_node(jsonNode.id);
		});
		//Mäta avstånd
		elToolbar.find("img[name=action_measure_distance]").click( () => {
			const measurement = viewer.measuringTool.startInsertion({
				showDistances: true,
					showArea: false,
					closed: false,
					name: 'Distance'});

				let measurementsRoot = $("#jstree_scene").jstree().get_json("measurements");
				let jsonNode = measurementsRoot.children.find(child => child.data.uuid === measurement.uuid);
				$.jstree.reference(jsonNode.id).deselect_all();
				$.jstree.reference(jsonNode.id).select_node(jsonNode.id);
			}
		);
		//Mäta höjd

		elToolbar.find("img[name=action_measure_height]").click( () => {
			const measurement = viewer.measuringTool.startInsertion({
				showDistances: false,
				showDistances: false,
					showHeight: true,
					showArea: false,
					closed: false,
					maxMarkers: 2,
					name: 'Height'});

				let measurementsRoot = $("#jstree_scene").jstree().get_json("measurements");
				let jsonNode = measurementsRoot.children.find(child => child.data.uuid === measurement.uuid);
				$.jstree.reference(jsonNode.id).deselect_all();
				$.jstree.reference(jsonNode.id).select_node(jsonNode.id);
				
		});
		//Höjdprofil
		elToolbar.find("img[name=action_measure_profile]").click( () => {
			const profile = viewer.profileTool.startInsertion({
			});
				let measurementsRoot = $("#jstree_scene").jstree().get_json("measurements");
				let jsonNode = measurementsRoot.children.find(child => child.data.uuid === profile.uuid);
				$.jstree.reference(jsonNode.id).deselect_all();
				$.jstree.reference(jsonNode.id).select_node(jsonNode.id);
				$("#menu_scene").next().show();
				$("#menu_scene").toggleClass('active');
			//viewer.toggleSidebar();
			});
		//Remove measurements
		elToolbar.find("img[name=action_measure_reset]").click( () => {
			
				viewer.scene.removeAllMeasurements();
			
			
		});
	}

	/* { // MATERIAL
		let options = [
			"rgba", 
			"elevation",
			"level of detail",
			"indices",
			// "intensity",
			// "classification",
			// "source id",
		];

		let attributeSelection = elToolbar.find('#optMaterial');
		for(let option of options){
			let elOption = $(`<option>${option}</option>`);
			attributeSelection.append(elOption);
		}

		const updateMaterialSelection = (event, ui) => {
			let selectedValue = attributeSelection.selectmenu().val();

			for(const pointcloud of viewer.scene.pointclouds){
				pointcloud.material.activeAttributeName = selectedValue;
			}
		};

		attributeSelection.selectmenu({change: updateMaterialSelection});
	}
 */
		/* {//show/hide Oriented Images
			elToolbar.find("chckOI").change( () => {
				console.log("laddar");
				
				const cameraParamsPath = "http://5.9.65.151/mschuetz/potree/resources/pointclouds/helimap/epalinges/img_selected/IXM35_190522_nodistortion.xml";
			const imageParamsPath = "http://5.9.65.151/mschuetz/potree/resources/pointclouds/helimap/epalinges/img_selected/Calib190522_MN95_NF2_cam_estim.txt";
			var image;
				 Potree.OrientedImageLoader.load(cameraParamsPath, imageParamsPath, viewer).then( images => {
					image = images;

				});
				viewer.scene.removeOrientedImages(image);
		});
		} */

	
	</script>
	
  </body>
</html>